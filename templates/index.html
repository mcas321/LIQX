<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIQX</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo2.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <img src="{{ url_for('static', filename='logo1.png') }}" alt="LIQX" class="header-logo">
        <div class="header-right">
            <div class="stats">
                <div>Total P&L: <span class="stat-value" id="totalPnl">$0.00</span></div>
                <div>Win Rate: <span class="stat-value" id="winRate">0%</span></div>
                <div>Trades: <span class="stat-value" id="totalTrades">0</span></div>
            </div>
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">&#9790;</button>
        </div>
    </header>

    <div class="calendar-wrapper">
        <div class="calendar-nav">
            <button onclick="changeMonth(-1)">&#8592; Prev</button>
            <h2 id="calendarTitle"></h2>
            <button onclick="changeMonth(1)">Next &#8594;</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h3 id="modalTitle"></h3>
            <div class="modal-trades" id="modalTrades"></div>
            <h3>Add Trade</h3>
            <form class="trade-form" id="tradeForm" onsubmit="submitTrade(event)">
                <div class="form-group">
                    <label>Asset</label>
                    <input type="text" id="asset" placeholder="e.g. BTC, ES, EURUSD" required>
                </div>
                <div class="form-group">
                    <label>Operation</label>
                    <select id="operation" required>
                        <option value="long">Long</option>
                        <option value="short">Short</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Result</label>
                    <select id="result" required>
                        <option value="win">Win</option>
                        <option value="loss">Loss</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Profit / Loss ($)</label>
                    <input type="number" step="0.01" id="profit" placeholder="e.g. 150 or -75" required>
                </div>
                <button type="button" class="time-toggle" id="timeToggle" onclick="toggleTimeFields()">+ Add time</button>
                <div class="time-fields" id="timeFields">
                    <div class="form-group">
                        <label>Entry Time</label>
                        <input type="time" id="entryTime">
                    </div>
                    <div class="form-group">
                        <label>Exit Time</label>
                        <input type="time" id="exitTime">
                    </div>
                </div>
                <button type="button" class="time-toggle" id="rrToggle" onclick="toggleRrField()">+ Add R:R</button>
                <div class="optional-field" id="rrField">
                    <div class="form-group">
                        <label>R:R Ratio</label>
                        <input type="number" step="0.01" min="0" id="rrRatio" placeholder="e.g. 2.5">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let selectedDate = null;
        let tradesCache = [];

        const MONTHS = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        const DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

        async function fetchTrades() {
            let res = await fetch(`/api/trades?month=${currentMonth + 1}&year=${currentYear}`);
            tradesCache = await res.json();
            renderCalendar();
            updateStats();
        }

        function getTradesForDate(dateStr) {
            return tradesCache.filter(t => t.date === dateStr);
        }

        function formatDate(year, month, day) {
            return `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        }

        function renderCalendar() {
            let grid = document.getElementById("calendarGrid");
            grid.innerHTML = "";

            document.getElementById("calendarTitle").textContent = `${MONTHS[currentMonth]} ${currentYear}`;

            DAYS.forEach(d => {
                let el = document.createElement("div");
                el.className = "calendar-header";
                el.textContent = d;
                grid.appendChild(el);
            });

            let firstDay = new Date(currentYear, currentMonth, 1).getDay();
            firstDay = firstDay === 0 ? 6 : firstDay - 1;

            let daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            let today = new Date();

            for (let i = 0; i < firstDay; i++) {
                let el = document.createElement("div");
                el.className = "calendar-day empty";
                grid.appendChild(el);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                let el = document.createElement("div");
                el.className = "calendar-day";

                let dateStr = formatDate(currentYear, currentMonth, day);

                if (today.getDate() === day && today.getMonth() === currentMonth && today.getFullYear() === currentYear) {
                    el.classList.add("today");
                }

                let dayTrades = getTradesForDate(dateStr);
                let pnl = dayTrades.reduce((sum, t) => sum + parseFloat(t.profit), 0);

                let html = `<div class="day-number">${day}</div>`;

                if (dayTrades.length > 0) {
                    html += `<div class="day-summary">`;
                    html += `<div>`;
                    dayTrades.forEach(t => {
                        html += `<span class="trade-dot ${t.result}"></span>`;
                    });
                    html += `</div>`;
                    html += `<div class="day-pnl" style="color: ${pnl >= 0 ? "#22c55e" : "#ef4444"}">`;
                    html += `${pnl >= 0 ? "+" : ""}$${pnl.toFixed(2)}`;
                    html += `</div>`;
                    html += `<div class="day-trades-count">${dayTrades.length} trade${dayTrades.length > 1 ? "s" : ""}</div>`;
                    html += `</div>`;
                }

                el.innerHTML = html;
                el.onclick = () => openModal(dateStr);
                grid.appendChild(el);
            }
        }

        function updateStats() {
            let total = tradesCache.reduce((s, t) => s + parseFloat(t.profit), 0);
            let wins = tradesCache.filter(t => t.result === "win").length;
            let rate = tradesCache.length > 0 ? ((wins / tradesCache.length) * 100).toFixed(1) : 0;

            let pnlEl = document.getElementById("totalPnl");
            pnlEl.textContent = `${total >= 0 ? "+" : ""}$${total.toFixed(2)}`;
            pnlEl.className = `stat-value ${total >= 0 ? "stat-positive" : "stat-negative"}`;

            document.getElementById("winRate").textContent = `${rate}%`;
            document.getElementById("totalTrades").textContent = tradesCache.length;
        }

        function openModal(dateStr) {
            selectedDate = dateStr;
            let parts = dateStr.split("-");
            document.getElementById("modalTitle").textContent = `${MONTHS[parseInt(parts[1]) - 1]} ${parseInt(parts[2])}, ${parts[0]}`;

            let dayTrades = getTradesForDate(dateStr);
            let container = document.getElementById("modalTrades");

            if (dayTrades.length === 0) {
                container.innerHTML = `<div class="no-trades">No trades yet</div>`;
            } else {
                container.innerHTML = dayTrades.map(t => `
                    <div class="trade-item">
                        <div class="trade-info">
                            <span class="trade-op"><span style="color:#3b82f6">${t.asset ? t.asset + " • " : ""}</span><span class="${t.operation}">${t.operation}</span></span>
                            <span class="trade-times">${[formatTradeTime(t), t.rr_ratio ? "R:R " + t.rr_ratio : ""].filter(Boolean).join(" &nbsp;|&nbsp; ")}</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span class="trade-profit" style="color: ${parseFloat(t.profit) >= 0 ? "#22c55e" : "#ef4444"}">
                                ${parseFloat(t.profit) >= 0 ? "+" : ""}$${parseFloat(t.profit).toFixed(2)}
                            </span>
                            <button class="delete-btn" onclick="deleteTrade(${t.id})">&#10005;</button>
                        </div>
                    </div>
                `).join("");
            }

            document.getElementById("tradeForm").reset();
            document.getElementById("timeFields").classList.remove("visible");
            document.getElementById("timeToggle").textContent = "+ Add time";
            document.getElementById("rrField").classList.remove("visible");
            document.getElementById("rrToggle").textContent = "+ Add R:R";
            document.getElementById("modalOverlay").classList.add("active");
        }

        function closeModal(e) {
            if (!e || e.target === e.currentTarget) {
                document.getElementById("modalOverlay").classList.remove("active");
                selectedDate = null;
            }
        }

        function formatTradeTime(t) {
            if (!t.entry_time && !t.exit_time) return "";
            let parts = `${t.entry_time} → ${t.exit_time}`;
            if (t.entry_time && t.exit_time) {
                let [h1, m1] = t.entry_time.split(":").map(Number);
                let [h2, m2] = t.exit_time.split(":").map(Number);
                let diff = (h2 * 60 + m2) - (h1 * 60 + m1);
                if (diff < 0) diff += 24 * 60;
                let dh = Math.floor(diff / 60);
                let dm = diff % 60;
                let dur = dh > 0 ? `${dh}h ${dm}m` : `${dm}m`;
                parts += ` (${dur})`;
            }
            return parts;
        }

        function toggleTimeFields() {
            let fields = document.getElementById("timeFields");
            let toggle = document.getElementById("timeToggle");
            let showing = fields.classList.toggle("visible");
            toggle.textContent = showing ? "− Remove time" : "+ Add time";
            if (!showing) {
                document.getElementById("entryTime").value = "";
                document.getElementById("exitTime").value = "";
            }
        }

        function toggleRrField() {
            let field = document.getElementById("rrField");
            let toggle = document.getElementById("rrToggle");
            let showing = field.classList.toggle("visible");
            toggle.textContent = showing ? "− Remove R:R" : "+ Add R:R";
            if (!showing) {
                document.getElementById("rrRatio").value = "";
            }
        }

        async function submitTrade(e) {
            e.preventDefault();
            let profit = parseFloat(document.getElementById("profit").value);
            let result = document.getElementById("result").value;
            if (result === "loss") profit = -Math.abs(profit);

            let trade = {
                date: selectedDate,
                asset: document.getElementById("asset").value.trim().toUpperCase(),
                entry_time: document.getElementById("entryTime").value || "",
                exit_time: document.getElementById("exitTime").value || "",
                operation: document.getElementById("operation").value,
                rr_ratio: document.getElementById("rrRatio").value ? parseFloat(document.getElementById("rrRatio").value) : null,
                result: result,
                profit: profit
            };

            await fetch("/api/trades", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(trade)
            });

            await fetchTrades();
            openModal(selectedDate);
        }

        async function deleteTrade(id) {
            await fetch(`/api/trades/${id}`, { method: "DELETE" });
            await fetchTrades();
            openModal(selectedDate);
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            fetchTrades();
        }

        document.addEventListener("keydown", e => {
            if (e.key === "Escape") closeModal();
        });

        function toggleTheme() {
            let html = document.documentElement;
            let current = html.getAttribute("data-theme");
            let next = current === "light" ? "dark" : "light";
            html.setAttribute("data-theme", next);
            localStorage.setItem("theme", next);
            document.getElementById("themeToggle").innerHTML = next === "light" ? "&#9728;" : "&#9790;";
        }

        (function() {
            let saved = localStorage.getItem("theme") || "dark";
            if (saved === "light") {
                document.documentElement.setAttribute("data-theme", "light");
                document.getElementById("themeToggle").innerHTML = "&#9728;";
            }
        })();

        fetchTrades();
    </script>

    <footer>
        <span>2026 LIQX</span>
    </footer>
</body>
</html>
